<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NonnaPunk | Cheesecakes Artesanales & Merch</title>
    <meta name="description" content="Cheesecakes artesanales con receta tradicional y un toque rebelde.">
    
    <script src="https://js.stripe.com/v3/"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. VARIABLES & BASE --- */
        :root {
            --color-fondo: #F9F7F2;
            --color-texto: #2C2C2C;
            --color-acento: #FF4757; /* Rojo Punk */
            --color-acento-hover: #ff2e40;
            --color-secundario: #ECCC68; /* Dorado */
            --color-negro-footer: #1a1a1a;
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--color-fondo);
            color: var(--color-texto);
            line-height: 1.6;
        }

        h1, h2, h3 { font-family: 'Playfair Display', serif; }

        /* --- 2. HEADER & NAV --- */
        header {
            background-color: rgba(255, 255, 255, 0.98);
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky; top: 0; z-index: 1000;
        }
        .header-content {
            max-width: 1200px; margin: 0 auto;
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo-img { height: 60px; width: auto; }
        
        nav { display: flex; align-items: center; gap: 20px; }
        nav a {
            text-decoration: none; color: var(--color-texto); font-weight: 600;
            transition: color 0.3s;
        }
        nav a:hover { color: var(--color-acento); }

        /* Estilo del Carrito en el Header */
        .header-cart-link {
            position: relative; font-size: 1.2rem; margin-left: 10px;
            display: inline-flex; align-items: center; text-decoration: none !important;
        }
        .header-badge {
            background-color: var(--color-acento); color: white;
            font-size: 0.7rem; font-weight: bold; height: 18px; width: 18px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            position: absolute; top: -8px; right: -8px;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .bump { transform: scale(1.5); } /* Animaci√≥n rebote */

        /* --- 3. HERO SECTION --- */
        .hero {
            text-align: center; padding: 120px 20px;
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1533134242443-d4fd215305ad?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover; background-position: center; color: white;
            background-attachment: fixed;
        }
        .hero h1 { font-size: clamp(2.5rem, 5vw, 4.5rem); margin-bottom: 20px; text-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .hero p { font-size: 1.2rem; max-width: 600px; margin: 0 auto; }
        .btn-cta {
            background-color: var(--color-acento); color: white; padding: 15px 40px;
            text-decoration: none; font-weight: bold; border-radius: 50px;
            display: inline-block; margin-top: 30px; transition: transform 0.3s;
        }
        .btn-cta:hover { transform: translateY(-3px); background-color: var(--color-acento-hover); }

        /* --- 4. HISTORIA --- */
        .story-box {
            background: white; padding: 60px; border-radius: 20px; text-align: center;
            max-width: 800px; margin: -50px auto 80px; position: relative; z-index: 10;
            box-shadow: 0 10px 40px rgba(0,0,0,0.05);
        }

        /* --- 5. GRID PRODUCTOS --- */
        .section-container { max-width: 1200px; margin: 60px auto; padding: 0 20px; }
        .section-title { text-align: center; margin-bottom: 40px; font-size: 2.5rem; }
        
        .grid-productos {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 35px;
        }
        .card-producto {
            background: white; border-radius: 16px; overflow: hidden;
            box-shadow: var(--shadow-soft); transition: transform 0.3s;
            display: flex; flex-direction: column; text-align: left;
        }
        .card-producto:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        
        /* Enlaces dentro de la tarjeta */
        .card-link { text-decoration: none; color: inherit; display: block; }
        
        .img-placeholder { width: 100%; height: 260px; object-fit: cover; }
        .info-producto { padding: 25px; display: flex; flex-direction: column; flex-grow: 1; }
        .info-producto h3 { font-size: 1.3rem; margin-bottom: 8px; transition: color 0.3s; }
        .card-producto:hover h3 { color: var(--color-acento); }
        .info-producto p { font-size: 0.95rem; color: #666; flex-grow: 1; margin-bottom: 15px; }
        .precio { font-size: 1.5rem; color: var(--color-acento); font-weight: bold; display: block; margin-bottom: 15px; }
        
        .btn-add-cart {
            background-color: #222; color: white; border: none; padding: 12px; width: 100%;
            border-radius: 50px; font-weight: 600; cursor: pointer; transition: 0.3s;
            font-family: 'Montserrat', sans-serif;
        }
        .btn-add-cart:hover { background-color: var(--color-acento); }

        /* Merch especial */
        .merch-bg { background-color: white; border-radius: 20px; padding: 60px 20px; box-shadow: var(--shadow-soft); margin-top: 80px;}

        /* --- 6. MODALES & CARRITO FLOTANTE --- */
        #cart-float {
            position: fixed; bottom: 30px; right: 30px;
            background: var(--color-acento); color: white;
            width: 65px; height: 65px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 28px; cursor: pointer; z-index: 999;
            box-shadow: 0 8px 25px rgba(255, 71, 87, 0.5);
            transition: transform 0.3s;
        }
        #cart-float:hover { transform: scale(1.1); }
        #cart-count {
            position: absolute; top: -5px; right: -5px;
            background: var(--color-secundario); color: var(--color-texto);
            font-size: 13px; font-weight: bold; width: 24px; height: 24px;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            border: 2px solid white;
        }

        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px); z-index: 2000;
            justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s;
        }
        .modal.active { display: flex; opacity: 1; }
        
        .modal-content {
            background: white; padding: 40px; width: 95%; max-width: 550px;
            border-radius: 20px; position: relative; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: slideUp 0.3s;
        }
        @keyframes slideUp { from {transform: translateY(50px); opacity:0;} to {transform: translateY(0); opacity:1;} }

        .close-modal {
            position: absolute; top: 20px; right: 25px;
            font-size: 28px; cursor: pointer; color: #999; border: none; background: none;
        }
        .close-modal:hover { color: var(--color-acento); }

        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; }
        .btn-remove { background: rgba(255, 71, 87, 0.1); color: var(--color-acento); padding: 5px 10px; border-radius: 5px; cursor: pointer; border: none; margin-left: 10px; }

        /* Formulario Stripe */
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; font-size: 0.9rem; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group textarea {
            width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px;
            font-family: 'Montserrat', sans-serif; font-size: 16px; outline: none; transition: 0.3s;
        }
        .form-group input:focus, .form-group textarea:focus { border-color: var(--color-acento); }
        
        #card-element { padding: 15px; border: 2px solid #eee; border-radius: 8px; background: white; }
        #card-errors { color: #FF4757; margin-top: 10px; font-size: 0.9rem; }

        .btn-checkout-confirm {
            background: var(--color-acento); color: white; width: 100%;
            padding: 16px; border: none; border-radius: 50px; font-weight: bold; font-size: 1.1rem;
            margin-top: 20px; cursor: pointer; box-shadow: 0 10px 20px rgba(255, 71, 87, 0.2);
        }
        .btn-checkout-confirm:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(255, 71, 87, 0.3); }

        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid white; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- 7. FOOTER --- */
        footer { background: var(--color-negro-footer); color: #ccc; padding: 80px 20px 40px; margin-top: 80px; }
        .footer-content { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; text-align: left; }
        .footer-col h3 { color: white; margin-bottom: 20px; }
        .footer-col a { color: #ccc; text-decoration: none; display: block; margin-bottom: 10px; transition: 0.3s; }
        .footer-col a:hover { color: var(--color-acento); }
        
        .social-icons { display: flex; gap: 15px; margin-top: 20px; }
        .social-icon { width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; text-decoration: none; transition: 0.3s; }
        .social-icon:hover { background: var(--color-acento); transform: translateY(-3px); }

        .copyright { margin-top: 60px; padding-top: 30px; border-top: 1px solid #333; text-align: center; font-size: 0.9rem; }

        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 15px; }
            .hero h1 { font-size: 2.5rem; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <a href="index.html" class="logo"><img src="logo.png" alt="NonnaPunk" class="logo-img"></a>
            <nav>
                <a href="#menu">Tartas</a>
                <a href="#merch">Merch</a>
                <a href="#footer">Contacto</a>
                <a href="#" onclick="toggleCart()" class="header-cart-link">
                    üõí <span id="headerCartCount" class="header-badge">0</span>
                </a>
            </nav>
        </div>
    </header>

    <section class="hero">
        <h1>Tradici√≥n Rebelde</h1>
        <p>Cheesecakes con la receta de la abuela y un toque que no te esperas.</p>
        <a href="#menu" class="btn-cta">VER EL MEN√ö</a>
    </section>

    <div class="story-box">
        <h2>El Concepto</h2>
        <p>¬øQu√© pasa cuando mezclas el cuaderno de recetas de 1950 con los antojos modernos? Nace <strong>NonnaPunk</strong>. Horneamos cada ma√±ana con huevos de granja y quesos cremosos, pero a√±adimos ingredientes que rompen las reglas. Sin conservantes, sin tonter√≠as, solo sabor brutal.</p>
    </div>

    <section id="menu" class="section-container">
        <h2 class="section-title">Edici√≥n Limitada</h2>
        <div class="grid-productos">
            
            <article class="card-producto">
                <a href="tarta-clasica.html" class="card-link"><img src="frutos.jpg" alt="Cl√°sica" class="img-placeholder"></a>
                <div class="info-producto">
                    <a href="tarta-clasica.html" class="card-link"><h3>La Cl√°sica de la Nonna</h3></a>
                    <p>Cremosa, suave y con coulis de frutos rojos silvestres.</p>
                    <span class="precio">25.00‚Ç¨</span>
                    <button class="btn-add-cart" onclick="addToCart('La Cl√°sica', 25.00)">A√ëADIR üõí</button>
                </div>
            </article>

            <article class="card-producto">
                <a href="tarta-oreo.html" class="card-link"><img src="tartaoreo.jpg" alt="Oreo" class="img-placeholder"></a>
                <div class="info-producto">
                    <a href="tarta-oreo.html" class="card-link"><h3>Oreo White Noise</h3></a>
                    <p>Chocolate blanco y galleta negra. Adicci√≥n pura.</p>
                    <span class="precio">28.00‚Ç¨</span>
                    <button class="btn-add-cart" onclick="addToCart('Oreo White', 28.00)">A√ëADIR üõí</button>
                </div>
            </article>

            <article class="card-producto">
                <a href="tarta-pistacho.html" class="card-link"><img src="pistacho.png" alt="Pistacho" class="img-placeholder"></a>
                <div class="info-producto">
                    <a href="tarta-pistacho.html" class="card-link"><h3>Pistacho & Azafr√°n</h3></a>
                    <p>Lujo comestible. Pistacho ib√©rico y hebras de azafr√°n.</p>
                    <span class="precio">28.00‚Ç¨</span>
                    <button class="btn-add-cart" onclick="addToCart('Pistacho Lux', 28.00)">A√ëADIR üõí</button>
                </div>
            </article>

             <article class="card-producto">
                <a href="tarta-mango.html" class="card-link"><img src="mango.jpg" alt="Mango" class="img-placeholder"></a>
                <div class="info-producto">
                    <a href="tarta-mango.html" class="card-link"><h3>Mango & Chili Fire</h3></a>
                    <p>Tropical y picante. Dulzura con final ardiente.</p>
                    <span class="precio">28.00‚Ç¨</span>
                    <button class="btn-add-cart" onclick="addToCart('Mango Fire', 28.00)">A√ëADIR üõí</button>
                </div>
            </article>

            <article class="card-producto">
                <a href="tarta-caramelo.html" class="card-link"><img src="caramelo.png" alt="Caramelo" class="img-placeholder"></a>
                <div class="info-producto">
                    <a href="tarta-caramelo.html" class="card-link"><h3>Salty Caramel Pretzel</h3></a>
                    <p>Caos perfecto: pretzels, caramelo y toffee.</p>
                    <span class="precio">28.00‚Ç¨</span>
                    <button class="btn-add-cart" onclick="addToCart('Salty Caramel', 28.00)">A√ëADIR üõí</button>
                </div>
            </article>

            <article class="card-producto">
                <a href="tarta-lotus.html" class="card-link"><img src="lotus.png" alt="Lotus" class="img-placeholder"></a>
                <div class="info-producto">
                    <a href="tarta-lotus.html" class="card-link"><h3>Lotus Overdose</h3></a>
                    <p>Galleta Lotus en base y cobertura. Ilegal.</p>
                    <span class="precio">28.00‚Ç¨</span>
                    <button class="btn-add-cart" onclick="addToCart('Lotus Overdose', 28.00)">A√ëADIR üõí</button>
                </div>
            </article>
        </div>
    </section>

    <section id="merch" class="section-container merch-bg">
        <h2 class="section-title">Viste la Revoluci√≥n</h2>
        <p style="text-align: center; margin-bottom: 40px;">No solo comas como un punk, v√≠stete como uno.</p>

        <div class="grid-productos">
            <article class="card-producto">
                <a href="camiseta-negra.html" class="card-link"><img src="camisetanegra.png" alt="Camiseta" class="img-placeholder"></a>
                <div class="info-producto">
                    <a href="camiseta-negra.html" class="card-link"><h3>T-Shirt "Team Nonna"</h3></a>
                    <p>Negro lavado. Algod√≥n org√°nico. Oversize.</p>
                    <span class="precio">10.00‚Ç¨</span>
                    <button class="btn-add-cart" onclick="addToCart('Camiseta Punk', 10.00)">A√ëADIR üõí</button>
                </div>
            </article>

            <article class="card-producto">
                <a href="bolsa.html" class="card-link"><img src="bolsa.png" alt="Bolsa" class="img-placeholder"></a>
                <div class="info-producto">
                    <a href="bolsa.html" class="card-link"><h3>Tote "Punk Carrier"</h3></a>
                    <p>Resistente para libros o tartas.</p>
                    <span class="precio">3.00‚Ç¨</span>
                    <button class="btn-add-cart" onclick="addToCart('Tote Bag', 3.00)">A√ëADIR üõí</button>
                </div>
            </article>

            <article class="card-producto">
                <a href="taza.html" class="card-link"><img src="taza.png" alt="Taza" class="img-placeholder"></a>
                <div class="info-producto">
                    <a href="taza.html" class="card-link"><h3>Mug "Breakfast Rebel"</h3></a>
                    <p>Cer√°mica robusta para caf√© XL.</p>
                    <span class="precio">5.00‚Ç¨</span>
                    <button class="btn-add-cart" onclick="addToCart('Mug Rebel', 5.00)">A√ëADIR üõí</button>
                </div>
            </article>
        </div>
    </section>

    <footer id="footer">
        <div class="footer-content">
            <div class="footer-col">
                <h3>NonnaPunk</h3>
                <p>Reposter√≠a artesanal con actitud en el coraz√≥n de Toledo. Rompiendo dietas desde 2025.</p>
                <div class="social-icons">
                    <a href="#" class="social-icon" aria-label="Instagram">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
                    </a>
                    <a href="#" class="social-icon" aria-label="TikTok">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12a4 4 0 1 0 4 4V4a5 5 0 0 0 5 5"></path></svg>
                    </a>
                    <a href="#" class="social-icon" aria-label="WhatsApp">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                    </a>
                </div>
            </div>
            
            <div class="footer-col">
                <h3>Contacto</h3>
                <p>üìç Calle Rebeli√≥n, 12, Melilla</p>
                <p>üìû +34 600 000 000</p>
                <p>üìß hola@nonnapunk.com</p>
                <p>‚è∞ Mar-Dom: 10:00 - 20:00</p>
            </div>

            <div class="footer-col">
                <h3>Legal & Ayuda</h3>
                <a href="legal.html#aviso-legal">Aviso Legal</a>
                <a href="legal.html#privacidad">Pol√≠tica de Privacidad</a>
                <a href="legal.html#cookies">Pol√≠tica de Cookies</a>
                <a href="legal.html#envios">Env√≠os y Devoluciones</a>
            </div>
        </div>
        
        <div class="copyright">
            <p>¬© 2025 NonnaPunk Cheesecakes. Proyecto Acad√©mico. Powered by Stripe & Zapier.</p>
        </div>
    </footer>

    <div id="cookie-banner" style="position: fixed; bottom: -100%; left: 0; width: 100%; background: #2C2C2C; color: white; padding: 20px; text-align: center; z-index: 9999; transition: bottom 0.5s; box-shadow: 0 -5px 20px rgba(0,0,0,0.2);">
        <div style="max-width: 1000px; margin: 0 auto; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 20px;">
            <p style="margin: 0; font-size: 0.9rem;">
                üç™ <strong>Usamos cookies</strong> (propias y de Stripe) para que puedas comprar tartas sin que explote la web. 
                Si sigues aqu√≠, asumimos que te parece bien. 
                <a href="legal.html#cookies" style="color: #ECCC68; text-decoration: underline;">Ver Pol√≠tica</a>.
            </p>
            <button onclick="acceptCookies()" style="background: #FF4757; color: white; border: none; padding: 10px 25px; border-radius: 50px; cursor: pointer; font-weight: bold;">ACEPTAR</button>
        </div>
    </div>

    <div id="cart-float" onclick="toggleCart()">
        üõí <span id="cartCount">0</span>
    </div>

    <div id="cartModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="toggleCart()">√ó</button>
            <h2>Tu Pedido Punk</h2>
            <div id="cartItems" style="margin: 20px 0;"></div>
            <div class="cart-total">Total: <span id="cartTotal">0.00‚Ç¨</span></div>
            <button class="btn-checkout-confirm" onclick="goToCheckout()">
                IR A PAGAR
            </button>
        </div>
    </div>

    <div id="checkoutModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeCheckout()">√ó</button>
            <h2>Pago Seguro</h2>
            <div id="checkoutContent">
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">Powered by <strong>Stripe</strong></p>
                <div id="orderSummary" style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:20px;"></div>
                
                <form id="payment-form">
                    <div class="form-group"><label>Nombre Completo</label><input type="text" id="customer-name" required></div>
                    <div class="form-group"><label>Email</label><input type="email" id="customer-email" required placeholder="tu@email.com"></div>
                    <div class="form-group"><label>Tel√©fono</label><input type="tel" id="customer-phone" required></div>
                    <div class="form-group"><label>Fecha Recogida</label><input type="date" id="pickup-date" required></div>
                    
                    <div class="form-group">
                        <label>Notas / Alergias (Opcional)</label>
                        <textarea id="customer-notes" rows="2" placeholder="Ej: Sin nueces, poner felicitaci√≥n..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Tarjeta de Cr√©dito</label>
                        <div id="card-element"></div>
                        <div id="card-errors" style="color:red; margin-top:5px; font-size:0.9rem;"></div>
                    </div>

                    <button type="submit" id="submit-button" class="btn-checkout-confirm">
                        <span id="button-text">PAGAR AHORA</span>
                        <div id="spinner" class="spinner" style="display: none;"></div>
                    </button>
                </form>
            </div>

            <div id="success-message" style="display:none; text-align: center;">
                <div style="font-size: 60px; margin-bottom: 20px;">ü§ò‚úÖ</div>
                <h3>¬°Pedido Confirmado!</h3>
                <p>Referencia: <strong id="order-number"></strong></p>
                <p>Te hemos enviado un email a: <br><strong id="confirm-email" style="color:var(--color-acento)"></strong></p>
                <p style="margin-top: 20px; color:#666;">¬°Nos vemos en la recogida!</p>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ‚ö†Ô∏è ZONA DE CONFIGURACI√ìN
        // ==========================================
        const CONFIG = {
            // Pon aqu√≠ tu clave p√∫blica de Stripe (pk_test_...)
            STRIPE_KEY: 'pk_test_51SqafBPfC2lL6XQld47q2pIqeZNRTVo2AH7OPDhOwn67Wb5rRH4iejHkTtbfflnmmVwLUJvfJyp9OXaXwqAIfnB200I6jqATf3', 
            // Pon aqu√≠ tu URL de Zapier
            ZAPIER_URL: 'https://hooks.zapier.com/hooks/catch/25982070/ugpz72v/' 
        };

        // --- 1. GESTI√ìN DEL CARRITO ---
        let cart = JSON.parse(localStorage.getItem('nonnaCart_v2')) || [];

        function updateCartUI() {
            // Guardar
            localStorage.setItem('nonnaCart_v2', JSON.stringify(cart));
            
            // Totales
            const totalQty = cart.reduce((sum, item) => sum + item.qty, 0);
            const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);

            // Actualizar contadores (Header + Flotante)
            const floatBadge = document.getElementById('cartCount');
            const headerBadge = document.getElementById('headerCartCount');
            
            if(floatBadge) floatBadge.innerText = totalQty;
            if(headerBadge) {
                headerBadge.innerText = totalQty;
                headerBadge.classList.remove('bump');
                void headerBadge.offsetWidth; // Trigger reflow
                headerBadge.classList.add('bump');
            }

            // Renderizar Lista
            const list = document.getElementById('cartItems');
            if(list) {
                list.innerHTML = '';
                if(cart.length === 0) {
                    list.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">Tu carrito est√° vac√≠o üò¢</p>';
                } else {
                    cart.forEach((item, idx) => {
                        list.innerHTML += `
                            <div class="cart-item">
                                <div><strong>${item.name}</strong><br><small>${item.qty} x ${item.price}‚Ç¨</small></div>
                                <div>
                                    <strong>${(item.price * item.qty).toFixed(2)}‚Ç¨</strong>
                                    <button class="btn-remove" onclick="removeFromCart(${idx})">√ó</button>
                                </div>
                            </div>
                        `;
                    });
                }
                const totalEl = document.getElementById('cartTotal');
                if(totalEl) totalEl.innerText = totalPrice.toFixed(2) + '‚Ç¨';
            }
        }

        window.addToCart = function(name, price) {
            const existing = cart.find(item => item.name === name);
            if (existing) { existing.qty++; } else { cart.push({ name, price, qty: 1 }); }
            updateCartUI();
            
            // Animaci√≥n visual carrito flotante
            const btn = document.getElementById('cart-float');
            btn.style.transform = "scale(1.2)";
            setTimeout(() => btn.style.transform = "scale(1)", 200);
        };

        window.removeFromCart = function(index) {
            cart.splice(index, 1);
            updateCartUI();
        };

        // --- 2. MODALES ---
        window.toggleCart = function() {
            const modal = document.getElementById('cartModal');
            modal.classList.toggle('active');
        };

        window.closeCheckout = function() {
            document.getElementById('checkoutModal').classList.remove('active');
        };

        window.goToCheckout = function() {
            if(cart.length === 0) return alert("¬°A√±ade algo primero!");
            toggleCart(); // Cierra carrito
            document.getElementById('checkoutModal').classList.add('active');
            
            // Resumen
            const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            document.getElementById('orderSummary').innerHTML = `<strong>Total a Pagar: ${total.toFixed(2)}‚Ç¨</strong>`;
            document.getElementById('button-text').innerText = `PAGAR ${total.toFixed(2)}‚Ç¨`;
            
            // Fecha m√≠nima ma√±ana
            const tmr = new Date(); tmr.setDate(tmr.getDate()+1);
            document.getElementById('pickup-date').min = tmr.toISOString().split('T')[0];

            initStripe();
        };

        // --- 3. STRIPE Y PAGO ---
        let stripe, elements, card;

        function initStripe() {
            if(stripe) return;
            try {
                stripe = Stripe(CONFIG.STRIPE_KEY);
                elements = stripe.elements();
                card = elements.create('card', {
                    style: { base: { fontSize: '16px', fontFamily: 'Montserrat', color: '#32325d' } }
                });
                card.mount('#card-element');
                card.on('change', ({error}) => {
                    document.getElementById('card-errors').textContent = error ? error.message : '';
                });
            } catch(e) { console.error(e); }
        }

        document.getElementById('payment-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submit-button');
    const spinner = document.getElementById('spinner');
    const txt = document.getElementById('button-text');
    
    // Bloquear bot√≥n mientras piensa
    btn.disabled = true; txt.style.display = 'none'; spinner.style.display = 'inline-block';

    // Calcular el total en C√âNTIMOS (Stripe lo exige as√≠. 25.00‚Ç¨ = 2500)
    const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.qty), 0) * 100;

    const data = {
        nombre: document.getElementById('customer-name').value,
        email: document.getElementById('customer-email').value,
        telefono: document.getElementById('customer-phone').value,
        fecha: document.getElementById('pickup-date').value,
        notas: document.getElementById('customer-notes').value,
        carrito: cart,
        total: document.getElementById('cartTotal').innerText
    };

    try {
        // PASO 1: Pedir el "Secreto" a tu Backend (El puente)
        const res = await fetch('/.netlify/functions/create-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount: totalAmount })
        });
        
        const { clientSecret, error: backendError } = await res.json();
        if (backendError) throw new Error(backendError);

        // PASO 2: Stripe valida la tarjeta y abre el banco si es necesario (SCA)
        const { paymentIntent, error: stripeError } = await stripe.confirmCardPayment(clientSecret, {
            payment_method: { card: card }
        });

        if (stripeError) throw new Error(stripeError.message);

        // PASO 3: ¬°PAGO REAL COMPLETADO! Ahora s√≠, enviamos el pedido a Zapier
        await fetch(CONFIG.ZAPIER_URL, {
            method: 'POST', mode: 'no-cors', 
            headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
        });

        // Mostrar √©xito en pantalla
        await new Promise(r => setTimeout(r, 1000));
        document.getElementById('checkoutContent').style.display = 'none';
        document.getElementById('success-message').style.display = 'block';
        document.getElementById('order-number').innerText = "NP-" + paymentIntent.id.slice(-6).toUpperCase();
        document.getElementById('confirm-email').innerText = data.email;
        cart = []; updateCartUI();

    } catch(err) {
        alert("Error en el pago: " + err.message);
        btn.disabled = false; txt.style.display = 'inline'; spinner.style.display = 'none';
    }
});

        // --- 4. COOKIES ---
        window.addEventListener('load', () => {
            updateCartUI();
            if (!localStorage.getItem('cookiesAccepted')) {
                setTimeout(() => document.getElementById('cookie-banner').style.bottom = '0', 1000);
            }
        });

        window.acceptCookies = function() {
            localStorage.setItem('cookiesAccepted', 'true');
            document.getElementById('cookie-banner').style.bottom = '-100%';
        };

        // Cerrar si click fuera
        window.onclick = function(e) {
            if (e.target.classList.contains('modal')) e.target.classList.remove('active');
        }
    </script>
</body>
</html>
